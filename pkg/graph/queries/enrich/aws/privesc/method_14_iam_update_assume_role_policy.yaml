name: Privesc Method 14 - UpdateAssumeRolePolicy
description: Creates CAN_PRIVESC relationship when a principal can update trust policies of roles
impactedServices:
  - IAM
severity: High
order: 111
cypher: |
  MATCH (principal)-[:IAM_UPDATEASSUMEROLEPOLICY]->(targetRole:AWS_IAM_Role)
  WHERE principal.admin IS NULL
    AND targetRole.admin = true
    // Check source-side sts:AssumeRole permission to this specific target
    AND principal.rolePolicyList CONTAINS 'sts:AssumeRole'
    AND principal.rolePolicyList CONTAINS targetRole.arn

  // Create the privesc relationship
  MERGE (principal)-[privesc:CAN_PRIVESC]->(targetRole)
  ON CREATE SET
    privesc.method = "Method-14-UpdateAssumeRolePolicy",
    privesc.requires = ["iam:UpdateAssumeRolePolicy", "sts:AssumeRole"],
    privesc.service = "IAM",
    privesc.targetType = "Role"
  ON MATCH SET
    privesc.method = CASE
      WHEN NOT privesc.method CONTAINS "Method-14-UpdateAssumeRolePolicy"
      THEN privesc.method + ",Method-14-UpdateAssumeRolePolicy"
      ELSE privesc.method
    END
