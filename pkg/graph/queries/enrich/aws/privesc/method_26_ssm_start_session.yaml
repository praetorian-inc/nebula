name: Privesc Method 26 - SSM StartSession
description: Creates CAN_PRIVESC relationship when a principal can start SSM sessions on instances with roles
impactedServices:
  - SSM
  - EC2
severity: High
order: 124
cypher: |
  MATCH (principal)-[:SSM_STARTSESSION]->(instance:AWS_EC2_Instance)
  WHERE principal.admin IS NULL
    AND instance.IamInstanceProfile IS NOT NULL

  // Match the actual IAM role using instanceProfileList
  MATCH (instanceRole:AWS_IAM_Role)
    WHERE instanceRole.instanceProfileList CONTAINS instance.IamInstanceProfile
    AND instanceRole.ssmEnabled = true

  // Create the privesc relationship to the instance's role
  MERGE (principal)-[privesc:CAN_PRIVESC]->(instanceRole)
  ON CREATE SET
    privesc.method = "Method-26-SSM-StartSession",
    privesc.requires = ["ssm:StartSession"],
    privesc.service = "SSM",
    privesc.targetType = "Role",
    privesc.instanceId = instance.instanceId
  ON MATCH SET
    privesc.method = CASE
      WHEN NOT privesc.method CONTAINS "Method-26-SSM-StartSession"
      THEN privesc.method + ",Method-26-SSM-StartSession"
      ELSE privesc.method
    END,
    privesc.instanceId = CASE
      WHEN privesc.instanceId IS NULL THEN instance.instanceId
      WHEN NOT privesc.instanceId CONTAINS instance.instanceId THEN privesc.instanceId + "," + instance.instanceId
      ELSE privesc.instanceId
    END

