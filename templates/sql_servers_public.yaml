id: sql_servers_public_access
name: Publicly Accessible SQL Servers
description: Detects SQL servers with firewall rules allowing public access
severity: High
category: Database
references:
  - https://learn.microsoft.com/en-us/azure/azure-sql/database/network-access-controls
query: |
    resources
    | where type =~ 'Microsoft.Sql/servers'
    | extend publicNetworkAccess = iif(isnotempty(properties.publicNetworkAccess), tolower(properties.publicNetworkAccess), 'enabled')
    | extend minimalTlsVersion = tostring(properties.minimalTlsVersion)
    | mv-expand firewallRule = properties.firewallRules
    | extend startIp = tostring(firewallRule.startIpAddress)
    | extend endIp = tostring(firewallRule.endIpAddress)
    | extend hasPublicAccess = startIp == '0.0.0.0' and endIp == '255.255.255.255'
    | where publicNetworkAccess != 'disabled'
    | where hasPublicAccess
    | project
        id,
        name,
        type,
        location,
        publicNetworkAccess,
        minimalTlsVersion,
        scope = 'server'
    | distinct *