id: overprivileged_custom_roles
name: Custom Roles with Privilege Escalation Permissions
description: Detects custom role definitions that contain permissions allowing privilege escalation through role assignments, classic administrator changes, or role definition modifications
severity: High
category: ["Privilege Escalation", "arg-scan"]
triageNotes: |
  Potential Risk:
  - Permissions that allow users to modify role assignments or definitions can lead to privilege escalation
  - Users could escalate their own privileges or grant elevated access to others
  - Classic Administrator write permissions are especially dangerous as they grant legacy full access
  
  Triage Guidance:
  - Check who is currently assigned these roles using role assignments
  - Validate privilege escalation using a simulated environment with the same permissions assigned
  - Check if role is used in PIM (Privileged Identity Management) for additional controls
references:
  - https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles
  - https://learn.microsoft.com/en-us/azure/role-based-access-control/resource-provider-operations
query: |
    AuthorizationResources
    | where type =~ 'microsoft.authorization/roledefinitions'
    | where properties.type == 'CustomRole'
    | mv-expand permission = properties.permissions
    | mv-expand action = permission.actions
    | where
        action =~ 'Microsoft.Authorization/*' or
        action =~ 'Microsoft.Authorization/role*' or
        action =~ 'Microsoft.Authorization/*/write' or
        action =~ 'Microsoft.Authorization/*/delete' or
        action =~ 'Microsoft.Authorization/roleAssignments/*' or
        action =~ 'Microsoft.Authorization/roleAssignments/write' or
        action =~ 'Microsoft.Authorization/roleAssignments/delete' or
        action =~ 'Microsoft.Authorization/roleDefinitions/*' or
        action =~ 'Microsoft.Authorization/roleDefinitions/write' or
        action =~ 'Microsoft.Authorization/roleDefinitions/delete' or
        action =~ 'Microsoft.Authorization/classicAdministrators/*' or
        action =~ 'Microsoft.Authorization/classicAdministrators/write' or
        action =~ 'Microsoft.Authorization/denyAssignments/*' or
        action =~ 'Microsoft.Authorization/denyAssignments/write' or
        action =~ 'Microsoft.Authorization/denyAssignments/delete' or
        action =~ 'Microsoft.ManagedIdentity/userAssignedIdentities/*/assign/action' or
        action =~ 'Microsoft.ManagedIdentity/*/assign/action' or
        action =~ '*/write' or
        action =~ '*'
    | extend 
        roleName = properties.roleName,
        roleDescription = properties.description,
        assignableScopes = array_strcat(properties.assignableScopes, ';')
    | project
        id,
        name,
        type,
        roleName,
        roleDescription,
        assignableScopes,
        dangerousAction = tostring(action),
        subscriptionId
