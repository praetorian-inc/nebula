# User-Assigned Managed Identity Nodes

User-assigned managed identities (explicitly created and assigned to resources).

## Node Labels

- `Resource` (shared)
- `AzureResource` (category)

## Properties

| Property | Type | Source | Required | Notes |
|----------|------|--------|----------|-------|
| `id` | string | `resourceMap["id"]` | ✅ | Normalized MI resource ID |
| `resourceType` | string | Constant | ✅ | `"Microsoft.ManagedIdentity/userAssignedIdentities"` |
| `displayName` | string | `resourceMap["name"]` | ✅ | MI name |
| `location` | string | `resourceMap["location"]` | ⚠️ | Azure region |
| `subscriptionId` | string | Parent subscription | ✅ | Subscription GUID |
| `resourceGroup` | string | `resourceMap["resourceGroup"]` | ⚠️ | RG name |
| `principalId` | string | `resourceMap["properties"]["principalId"]` | ✅ | Principal ID for linking to SP |
| `metadata` | string (JSON) | Computed | ✅ | JSON with assignmentType: "User-Assigned", synthetic: false |

## MERGE Key

```cypher
{id: toLower($miResourceId)}
```

**Uniqueness:** One node per user-assigned managed identity

## Source Data

**Location:** `consolidatedData["azure_resources"][subscriptionId]["azureResources"]`

Filtered by resource type: `"microsoft.managedidentity/userassignedidentities"`

**Example:**
```json
{
  "azure_resources": {
    "subscription-guid-123": {
      "azureResources": [
        {
          "id": "/subscriptions/sub-guid/resourceGroups/identity-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/my-uami",
          "name": "my-uami",
          "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
          "location": "eastus",
          "resourceGroup": "identity-rg",
          "properties": {
            "principalId": "principal-guid-123",
            "clientId": "client-guid-456",
            "tenantId": "tenant-guid-789"
          }
        }
      ]
    }
  }
}
```

## Creation Logic

**Function:** `createAzureResourceNodes()` - line 1035

**Batch Size:** 1000 user-assigned MIs per transaction (part of Azure resources batch)

**Processing:**
User-assigned MIs are created as regular Azure resources (included in security-relevant filter).

**Cypher Pattern:**
```cypher
UNWIND $resources AS resource
MERGE (r:Resource:AzureResource {id: resource.id})
ON CREATE SET
    r.resourceType = "Microsoft.ManagedIdentity/userAssignedIdentities",
    r.displayName = resource.displayName,
    r.location = resource.location,
    r.subscriptionId = resource.subscriptionId,
    r.resourceGroup = resource.resourceGroup,
    r.principalId = resource.principalId,
    r.metadata = COALESCE(resource.metadata, '{}')
```

## Metadata for User-Assigned MIs

For user-assigned managed identities collected as Azure resources:

```go
metadata := map[string]interface{}{
    "assignmentType": "User-Assigned",
    "synthetic": false,
}
```

**Fields:**
- `assignmentType`: `"User-Assigned"` (distinguishes from system-assigned)
- `synthetic`: `false` (real Azure resource, not generated by importer)

## Related Edges

### Outgoing

- [CONTAINS](../CONTAINS/mi-to-sp.md) - Backing service principal

### Incoming

- [CONTAINS](../CONTAINS/rg-to-resource.md) - Parent resource group
- [CAN_ESCALATE](../CAN_ESCALATE/) - From resources with this MI attached (via IMDS)

## User-Assigned vs System-Assigned

| Aspect | User-Assigned | System-Assigned |
|--------|---------------|-----------------|
| **Lifecycle** | Independent from resource | Tied to resource lifecycle |
| **Reusability** | Can be assigned to multiple resources | One per resource |
| **Creation** | Explicitly created as resource | Created automatically with resource |
| **Resource Type** | `Microsoft.ManagedIdentity/userAssignedIdentities` | `Microsoft.ManagedIdentity/systemAssigned` |
| **Node Source** | Azure resource data | Synthetic (created via Cypher) |
| **synthetic** | `false` | `true` |
| **ID Pattern** | `/subscriptions/.../userAssignedIdentities/{name}` | `/virtual/managedidentity/system/{principalId}` |

## Assignment Pattern

User-assigned MIs are attached to resources via `identity.userAssignedIdentities`:

```json
{
  "id": "/subscriptions/sub/resourceGroups/rg/providers/Microsoft.Compute/virtualMachines/vm1",
  "identity": {
    "type": "UserAssigned",
    "userAssignedIdentities": {
      "/subscriptions/sub/resourceGroups/rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/uami-1": {},
      "/subscriptions/sub/resourceGroups/rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/uami-2": {}
    }
  }
}
```

**Graph Representation:**
- VM resource node has `userAssignedIdentities = [uami-1-id, uami-2-id]` property
- Separate UAMI nodes exist as Azure resources
- CAN_ESCALATE edges: VM → UAMI (IMDS token theft vectors)

## Query Examples

### Find all user-assigned managed identities
```cypher
MATCH (uami:Resource:AzureResource)
WHERE toLower(uami.resourceType) = "microsoft.managedidentity/userassignedidentities"
RETURN uami.displayName, uami.principalId, uami.location
```

### Find UAMIs with backing service principals
```cypher
MATCH (uami:Resource:AzureResource)-[:CONTAINS]->(sp:Resource:Identity:Principal)
WHERE toLower(uami.resourceType) = "microsoft.managedidentity/userassignedidentities"
  AND toLower(sp.resourceType) = "microsoft.directoryservices/serviceprincipals"
RETURN uami.displayName, sp.displayName, sp.appId
```

### Find resources using a specific UAMI
```cypher
MATCH (resource:Resource:AzureResource)
WHERE $uamiId IN resource.userAssignedIdentities
RETURN resource.displayName, resource.resourceType
```

### Find UAMIs that can be compromised via IMDS
```cypher
MATCH (resource:Resource:AzureResource)-[r:CAN_ESCALATE]->(uami:Resource:AzureResource)
WHERE toLower(uami.resourceType) = "microsoft.managedidentity/userassignedidentities"
  AND r.method = "ResourceAttachedUserAssignedIdentity"
RETURN resource.displayName as compromisable_resource,
       uami.displayName as managed_identity
```

### Find UAMIs by resource group
```cypher
MATCH (rg:Resource:Hierarchy)-[:CONTAINS]->(uami:Resource:AzureResource)
WHERE toLower(rg.resourceType) = "microsoft.resources/resourcegroups"
  AND toLower(uami.resourceType) = "microsoft.managedidentity/userassignedidentities"
  AND rg.displayName = "identity-rg"
RETURN uami.displayName, uami.principalId
```

### Find UAMIs with permissions
```cypher
MATCH (sp:Resource:Identity:Principal)-[perm:HAS_PERMISSION]->(target:Resource)
WHERE (sp)<-[:CONTAINS]-(:Resource:AzureResource {resourceType: "Microsoft.ManagedIdentity/userAssignedIdentities"})
RETURN sp.displayName as service_principal,
       perm.permission as permission,
       target.displayName as target
```

## Test Cases

### Test 1: UAMI Creation
**Input:**
```json
{
  "azure_resources": {
    "sub-test-001": {
      "azureResources": [
        {
          "id": "/subscriptions/sub-test-001/resourceGroups/identity-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/test-uami",
          "name": "test-uami",
          "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
          "location": "eastus",
          "resourceGroup": "identity-rg",
          "properties": {
            "principalId": "uami-principal-001",
            "clientId": "uami-client-001"
          }
        }
      ]
    }
  }
}
```

**Expected:**
- Node created with labels: `Resource:AzureResource`
- `resourceType = "Microsoft.ManagedIdentity/userAssignedIdentities"`
- `principalId = "uami-principal-001"`
- `displayName = "test-uami"`
- `location = "eastus"`
- Metadata indicates `assignmentType: "User-Assigned"`, `synthetic: false`

### Test 2: UAMI Assigned to Resource
**Input:**
```json
{
  "azure_resources": {
    "sub-test-002": {
      "azureResources": [
        {
          "id": "/subscriptions/sub-test-002/.../Microsoft.ManagedIdentity/userAssignedIdentities/shared-uami",
          "name": "shared-uami",
          "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
          "properties": {"principalId": "shared-principal"}
        },
        {
          "id": "/subscriptions/sub-test-002/.../Microsoft.Compute/virtualMachines/vm1",
          "name": "vm1",
          "type": "Microsoft.Compute/virtualMachines",
          "identity": {
            "type": "UserAssigned",
            "userAssignedIdentities": {
              "/subscriptions/sub-test-002/.../userAssignedIdentities/shared-uami": {}
            }
          }
        }
      ]
    }
  }
}
```

**Expected:**
- Two nodes created: UAMI node + VM node
- VM node has `userAssignedIdentities` property containing UAMI resource ID
- CAN_ESCALATE edge: VM → UAMI (method: ResourceAttachedUserAssignedIdentity)

### Test 3: Multiple UAMIs
**Input:**
```json
{
  "azure_resources": {
    "sub-test-003": {
      "azureResources": [
        {
          "id": "/subscriptions/sub-test-003/.../uami-1",
          "name": "uami-1",
          "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
          "properties": {"principalId": "principal-1"}
        },
        {
          "id": "/subscriptions/sub-test-003/.../uami-2",
          "name": "uami-2",
          "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
          "properties": {"principalId": "principal-2"}
        }
      ]
    }
  }
}
```

**Expected:**
- Two separate UAMI nodes created
- Each with unique principalId
- No duplicate nodes

### Test 4: UAMI-SP Linkage
**Input:**
```json
{
  "azure_ad": {
    "servicePrincipals": [
      {
        "id": "sp-for-uami",
        "appId": "uami-client-id",
        "displayName": "test-uami",
        "servicePrincipalType": "ManagedIdentity"
      }
    ]
  },
  "azure_resources": {
    "sub-test-004": {
      "azureResources": [
        {
          "id": "/subscriptions/sub-test-004/.../uami-with-sp",
          "name": "test-uami",
          "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
          "properties": {
            "principalId": "matching-principal-id"
          }
        }
      ]
    }
  }
}
```

**Expected:**
- UAMI node created
- SP node created
- MI CONTAINS SP edge created (matched by principalId)

### Test 5: Idempotency
**Action:** Run import twice with same UAMI data

**Expected:**
- Only one node created per UAMI
- No duplicate nodes
- Properties unchanged on second run

### Test 6: Case Normalization
**Input:**
```json
{
  "azure_resources": {
    "SUB-TEST-006": {
      "azureResources": [
        {
          "id": "/subscriptions/SUB-TEST-006/.../UAMI-UPPER",
          "name": "UAMI-UPPER",
          "type": "Microsoft.ManagedIdentity/userAssignedIdentities"
        }
      ]
    }
  }
}
```

**Expected:**
- `id` normalized to lowercase
- `displayName` preserves original casing: `"UAMI-UPPER"`

## Implementation

**File:** `nebula/pkg/links/azure/iam/neo4j_importer.go`

**Function:** `createAzureResourceNodes()` starting at line 1035

**Batch Processing:** User-assigned MIs processed in same batch as other Azure resources (1000 per transaction)

**Filter:** Included in security-relevant resource types list

## Related Documentation

- [Data Schema](../data-schema.md#52-azureresources-array) - JSON input format
- [System-Assigned MI Nodes](system-assigned-mi.md) - Comparison
- [Azure Resource Nodes](azure-resource.md) - Parent category
- [MI CONTAINS SP](../CONTAINS/mi-to-sp.md) - Backing SP edge
- [CAN_ESCALATE IMDS](../CAN_ESCALATE/) - Token theft vectors
