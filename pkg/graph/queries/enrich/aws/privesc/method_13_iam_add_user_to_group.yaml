name: Privesc Method 13 - AddUserToGroup
description: Creates CAN_PRIVESC relationship when a user can add itself to privileged groups
impactedServices:
  - IAM
severity: High
order: 107
cypher: |
  MATCH (principal:AWS_IAM_User)-[:IAM_ADDUSERTOGROUP]->(group:AWS_IAM_Group)
  WHERE principal.admin IS NULL
  AND (principal.groupList IS NULL OR NOT group.arn IN principal.groupList)
  AND (group.admin = true)

  // Create self-escalation relationship via group addition
  MERGE (principal)-[privesc:CAN_PRIVESC]->(principal)
  ON CREATE SET
    privesc.method = "Method-13-AddUserToGroup",
    privesc.requires = ["iam:AddUserToGroup"],
    privesc.service = "IAM",
    privesc.targetType = "Self",
    privesc.targetGroup = group.arn,
    privesc.discovered = datetime()
  ON MATCH SET
    privesc.method = CASE
      WHEN NOT privesc.method CONTAINS "Method-13-AddUserToGroup"
      THEN privesc.method + ",Method-13-AddUserToGroup"
      ELSE privesc.method
    END,
    privesc.targetGroup = CASE
      WHEN privesc.targetGroup IS NULL THEN group.arn
      WHEN NOT privesc.targetGroup CONTAINS group.arn THEN privesc.targetGroup + "," + group.arn
      ELSE privesc.targetGroup
    END

  // Mark as self-escalation capable
  SET principal.canSelfEscalate = true
