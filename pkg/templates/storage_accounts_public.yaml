id: storage_accounts_public_access
name: Publicly Accessible Storage Accounts
description: Detects storage accounts with public network access enabled, default allow action, and blob public access not explicitly disabled (null or true). Manual triage of IP rules are necessary.
severity: Medium
category: ["Public Access", "arg-scan"]
reportability: Automatic
triageNotes: |
  Potential Risk:
  - Public accessibility exposes storage endpoints to the entire internet
  - Could lead to unauthorized data access attempts
  - Potential for data exfiltration if misconfigured
  
  Triage Guidance:
  - This finding only confirms the storage account is accessible from the internet and not anonymous access
  - This finding does not take into consideration fine-grained IP rules, always check manually if storage account hasIpRules and hasVnetRules is not returning a 0 value
  - Additional manual testing is required to determine if anonymous/unauthorized access is possible
  - Readers do not have object-level access, some additional permissions or shoulder surfing may be required
references:
  - https://learn.microsoft.com/en-us/azure/storage/common/storage-network-security
query: |
  resources
  | where type =~ 'Microsoft.Storage/storageAccounts'
  | extend publicNetworkAccess = tostring(properties.publicNetworkAccess)
  | extend allowBlobPublicAccess = properties.allowBlobPublicAccess
  | extend acls = properties.networkAcls
  | extend defaultAction = tostring(acls.defaultAction)
  | extend hasIpRules = array_length(acls.ipRules)
  | extend hasVnetRules = array_length(acls.virtualNetworkRules)
  | extend ipRules = acls.ipRules
  | extend virtualNetworkRules = acls.virtualNetworkRules
  | where publicNetworkAccess != 'Disabled'
  | where defaultAction == 'Allow'
  | where allowBlobPublicAccess == true or isnull(allowBlobPublicAccess)
  | project
      id,
      name,
      type,
      location,
      publicNetworkAccess,
      allowBlobPublicAccess,
      defaultAction,
      hasIpRules,
      hasVnetRules,
      ipRules,
      virtualNetworkRules,
      subscriptionId