id: function_apps_public_exposure
name: Function Apps Publicly Exposed
description: Detects Azure Function Apps without private endpoints and with public network access enabled. Function Apps are typically backend services that should not be directly exposed to the internet. This template identifies Function Apps that have only public access with no private endpoint fallback, increasing the attack surface for reconnaissance, brute force, and exploitation attempts.
severity: Medium
category: ["Public Access", "arg-scan"]
reportability: Manual Triage
triageNotes: |
  Important Context:
  This scan identifies Azure Function Apps that have public network access enabled AND no private endpoint connections.

  Understanding Function App Network Access:
  - Function Apps are typically backend services, not public-facing web applications
  - Unlike Web Apps, Function Apps usually should have restricted access
  - Public network access without private endpoints means the Function App is ONLY accessible via public internet
  - Private endpoints provide secure access from within a VNet

  Overlap with App Services Public Access Template:
  - The app_services_public_access template also detects microsoft.web/sites with public access enabled
  - This template is MORE specific: it targets only Function Apps AND requires absence of private endpoints
  - Findings from this template will be a subset of app_services_public_access findings
  - This template provides Function App-specific triage guidance and enrichment

  Key Differences from General App Service Public Access:
  - This template specifically targets Function Apps (kind contains 'functionapp')
  - Only flags Function Apps that have NO private endpoint connections at all
  - More restrictive than general App Service public access detection
  - Function Apps typically have different security requirements than public Web Apps

  Escalate to High Priority If:
  - The function has ANY trigger with Anonymous auth level (no function key or AAD token required)
    AND the function's managed identity has broad RBAC assignments (Contributor, Owner, high-privilege
    data plane roles) — this combination allows unauthenticated callers to indirectly abuse cloud permissions
  - The Function App processes sensitive data (PII, financial, healthcare) without network isolation

  Hosting Plan and Networking Limitations:
  - Consumption plan Function Apps CANNOT use private endpoints — this is an Azure platform constraint.
    Findings on Consumption plan apps (identifiable by hostingPlan referencing a Consumption server farm)
    may be expected/unavoidable and should be triaged as lower priority unless auth controls are weak.
  - Premium (EP1/EP2/EP3) and Dedicated (App Service Plan) Function Apps fully support private endpoints.
    These findings are higher priority for remediation.

  Security Implications:
  - Direct internet exposure of backend functions
  - Increased vulnerability to automated scanning and exploitation
  - Bypass of intended access controls
  - Backend functions may contain business logic not intended for public access
  - API endpoints may lack proper authentication mechanisms

  Compensating Controls to Evaluate:
  - Function Keys (host/function-level keys): Require a valid key in the request — weaker than
    identity-based auth (keys can be leaked or shared), but meaningful for public webhook scenarios
  - Azure AD / Entra ID Authentication (EasyAuth): Callers must present a valid AAD token — strong
    compensating control; verify via the Authentication blade in the portal
  - IP Restrictions: Verify allow-list rules are scoped appropriately — a 0.0.0.0/0 allow rule
    or an absence of any restriction negates the control. NOTE: hasIpRestrictions=true may include
    the default 'Allow All' rule that Azure returns even when no real restrictions are configured;
    always verify actual restriction rules manually in the portal
  - API Management (APIM) fronting: If the function is only callable via APIM with restrictive
    network policies, direct public access may be intentionally blocked at the APIM layer

  Known Limitation — Private Endpoint Connection State:
  This query counts any entry in privateEndpointConnections as a valid private endpoint, including
  connections in "Pending" or "Rejected" state. A pending PE provides no actual network isolation.
  During triage, verify that any private endpoint shown is in "Approved" state via the Azure portal
  or az network private-endpoint-connection list.

  Triage Guidance:
  1. Check the hosting plan (hostingPlan field) — Consumption plan = lower remediation priority
  2. Check authentication: EasyAuth + AAD = strong compensating control, Anonymous = escalate
  3. Check hasIpRestrictions — verify actual rules, not just the default Allow All rule
  4. Identify trigger types and intended audience (internal vs external callers)
  5. Verify private endpoint state if PE count appears > 0 in raw properties
  6. Check if fronted by APIM or Azure Front Door with WAF policies

  Common Scenarios:
  - Webhook receivers for third-party services (GitHub, Stripe, Twilio, SendGrid) that require
    a publicly reachable HTTPS endpoint
  - Public API backends serving mobile or external clients
  - Development/testing Function Apps may not have private endpoints configured
  - Internal backend services misconfigured for public access
  - Function Apps integrated with Logic Apps or other services may require specific access patterns
  - Consumption plan functions where private endpoint isolation is architecturally unavailable

  Remediation Steps:
  - Private: Set publicNetworkAccess to 'Disabled' + configure private endpoint (requires Premium/Dedicated plan)
  - Public but hardened: Enable EasyAuth with Entra ID, enforce HTTPS-only, restrict trigger auth level
    to Function or Admin key minimum, configure IP restrictions for known source ranges
  - Consumption plan: Enforce Entra ID auth or function keys, enable HTTPS-only, add IP restrictions
    where source IPs are known; private endpoint isolation requires plan upgrade
references:
  - https://learn.microsoft.com/en-us/azure/azure-functions/functions-networking-options
  - https://learn.microsoft.com/en-us/azure/azure-functions/functions-create-private-site-access
  - https://learn.microsoft.com/en-us/azure/azure-functions/security-concepts
  - https://learn.microsoft.com/en-us/azure/app-service/networking-features
  - https://learn.microsoft.com/en-us/azure/templates/microsoft.web/sites
  - https://github.com/projectdiscovery/nuclei-templates/blob/main/cloud/azure/functions/azure-functionapp-public-exposure.yaml
query: |
    resources
    | where type =~ 'microsoft.web/sites'
    // Scope to Function Apps only; App Services share this resource type
    | where kind contains 'functionapp'
    // coalesce: null publicNetworkAccess means public access is implicitly ON by default
    | extend publicNetworkAccess = tolower(coalesce(properties.publicNetworkAccess, 'Enabled'))
    // Pattern C: coalesce array_length to 0 when property is null, making null-safety explicit.
    // Note: this counts PE connections in any state (Pending/Rejected/Approved); verify PE
    // state during triage as only Approved connections provide actual network isolation.
    | extend peCount = coalesce(array_length(properties.privateEndpointConnections), 0)
    | extend hasPrivateEndpoint = peCount > 0
    // Note: hasIpRestrictions may be true due to default 'Allow All' rule — verify actual rules
    | extend hasIpRestrictions = coalesce(array_length(properties.siteConfig.ipSecurityRestrictions), 0) > 0
    | extend hostingPlan = tostring(properties.serverFarmId)
    | extend httpsOnly = coalesce(tobool(properties.httpsOnly), false)
    | where publicNetworkAccess != 'disabled'
    | where hasPrivateEndpoint == false
    | project
        id,
        name,
        type,
        kind,
        location,
        resourceGroup,
        publicNetworkAccess,
        hasPrivateEndpoint,
        hasIpRestrictions,
        hostingPlan,
        httpsOnly,
        subscriptionId
