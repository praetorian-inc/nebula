id: vm_ssh_password_authentication
name: VM SSH Password Authentication Enabled
description: Detects Azure Linux virtual machines configured with SSH password authentication enabled (disablePasswordAuthentication=false). Password-based SSH authentication exposes VMs to credential-based attacks including brute-forcing, password spraying, and compromise via weak or default credentials. SSH key-based authentication provides stronger security by eliminating password vulnerabilities.
severity: High
category: ["Access Control", "arg-scan"]
reportability: Automatic
triageNotes: |
  Security Risk:
  Linux VMs with SSH password authentication enabled allow users to authenticate using username/password
  credentials instead of SSH keys. This configuration significantly increases the attack surface and
  exposes VMs to various credential-based attacks including brute-force, password spraying, credential
  stuffing, and compromise via weak, reused, or default passwords.

  Attack Vector:
  - Brute-force attacks on SSH port (typically port 22)
  - Password spraying across multiple accounts
  - Credential stuffing using leaked password databases
  - Exploitation of weak or default passwords
  - Dictionary attacks against common passwords
  - Compromise via shared or reused passwords
  - Insider threats with access to password credentials

  Understanding SSH Authentication Methods:
  - Password Authentication: Username/password credentials (vulnerable - this finding)
  - SSH Key Authentication: Public/private key pairs (secure, recommended)
  - Property: properties.osProfile.linuxConfiguration.disablePasswordAuthentication
  - When false: Password authentication is ENABLED (vulnerable)
  - When true: Password authentication is DISABLED, only SSH keys accepted (secure)
  - Default: Varies by deployment method (Azure Portal defaults to keys, CLI allows passwords)

  SSH Password Authentication vs SSH Key Authentication:
  - Password Auth: Susceptible to brute-force, weak passwords, credential reuse
  - Key Auth: Cryptographically strong, immune to brute-force, no password to steal
  - Best Practice: Disable password auth entirely, use SSH keys exclusively
  - Defense-in-Depth: Combine SSH keys with network restrictions (NSG, Bastion)

  Detection Method:
  This detection uses Azure Resource Graph to query VM configuration:
  - ARG Query: Identifies Linux VMs with disablePasswordAuthentication=false
  - Native ARG: No enricher required, property available in ARG
  - Checks: properties.osProfile.linuxConfiguration.disablePasswordAuthentication
  - Filters: Only Linux VMs (osType='Linux')
  - Requires: Reader permission (Microsoft.Compute/virtualMachines/read)

  Common Scenarios:
  - Legacy VMs migrated from on-premises without key-based auth configuration
  - Quick development/testing VMs created with password authentication
  - Emergency access scenarios where SSH keys weren't properly configured
  - VMs created via CLI/scripts without explicit SSH key specification
  - Organizational policies not enforcing SSH key requirements
  - Lack of awareness about SSH key best practices

  Legitimate Use Cases:
  - Development/testing environments (but still discouraged)
  - Temporary VMs for short-term projects (< 24 hours)
  - Environments behind strong network isolation with MFA
  - Legacy applications requiring password authentication (should be migrated)

  Triage Guidance:
  1. Verify if this is a production VM (critical priority) or dev/test (medium priority)
  2. Check VM network exposure (public IP, NSG rules allowing SSH from internet)
  3. Review authentication logs for suspicious login attempts (failed logins, unusual IPs)
  4. Verify password complexity and whether it follows organizational policy
  5. Check if multi-factor authentication (MFA) is enabled at network level
  6. Determine if VM is behind Azure Bastion or jump host (reduces exposure)
  7. Review Azure Security Center recommendations for this VM
  8. Assess criticality of workload running on the VM

  Remediation Steps:
  1. Generate SSH key pair if not already available:
     ```bash
     # On local machine
     ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
     ```

  2. Add SSH public key to VM:
     ```bash
     # Option 1: Using Azure CLI
     az vm user update \
       --resource-group <rg> \
       --name <vm-name> \
       --username <admin-user> \
       --ssh-key-value "$(cat ~/.ssh/id_rsa.pub)"

     # Option 2: Using Azure Portal
     # VM → Reset password → Reset SSH public key → Paste public key
     ```

  3. Verify SSH key access works:
     ```bash
     ssh -i ~/.ssh/id_rsa <admin-user>@<vm-ip>
     ```

  4. Disable password authentication (CRITICAL - do this last):
     ```bash
     # Connect to VM and edit SSH config
     sudo vi /etc/ssh/sshd_config

     # Set these values:
     PasswordAuthentication no
     ChallengeResponseAuthentication no
     UsePAM no

     # Restart SSH service
     sudo systemctl restart sshd
     ```

  5. Update VM configuration in Azure:
     ```bash
     # This requires VM recreation or extension deployment
     # Azure does not allow runtime modification of disablePasswordAuthentication
     # Best approach: Redeploy VM with SSH keys from ARM/Bicep template
     ```

  6. Network-level protections (defense-in-depth):
     - Restrict SSH access via NSG to specific IP ranges
     - Use Azure Bastion for secure browser-based SSH access
     - Implement Just-In-Time (JIT) VM access via Security Center
     - Enable Azure Firewall for centralized traffic filtering
     - Use Azure Private Link for internal-only access

  7. Monitoring and alerting:
     - Enable Azure Monitor for SSH login auditing
     - Set up alerts for failed SSH authentication attempts
     - Review Azure Activity Log for unauthorized access attempts
     - Implement SIEM integration for security event correlation

  Azure CLI Commands:
  ```bash
  # Check current SSH authentication configuration
  az vm show --resource-group <rg> --name <vm-name> \
    --query 'osProfile.linuxConfiguration.disablePasswordAuthentication'

  # List all VMs with password authentication enabled
  az graph query -q "resources | where type =~ 'microsoft.compute/virtualmachines' | where properties.storageProfile.osDisk.osType =~ 'Linux' | where properties.osProfile.linuxConfiguration.disablePasswordAuthentication == false | project name, resourceGroup"

  # Add SSH public key to VM
  az vm user update --resource-group <rg> --name <vm-name> \
    --username <admin-user> --ssh-key-value @~/.ssh/id_rsa.pub

  # Check NSG rules for SSH access
  az network nsg rule list --resource-group <rg> --nsg-name <nsg-name> \
    --query "[?destinationPortRange=='22' || destinationPortRange=='*'].{Name:name, Priority:priority, Access:access, SourceAddressPrefix:sourceAddressPrefix}"
  ```

  Compliance Impact:
  - Violates CIS Azure Foundations Benchmark (VM authentication controls)
  - Fails PCI-DSS requirements for strong access controls
  - May violate HIPAA, SOC 2, ISO 27001 authentication requirements
  - Increases risk of unauthorized access and data breaches
  - Fails security best practices for cloud infrastructure

  Additional Considerations:
  - SSH keys should be rotated periodically (recommend 90 days)
  - Use different SSH keys for different VMs/environments
  - Protect SSH private keys with passphrase encryption
  - Store SSH keys securely (e.g., Azure Key Vault, hardware tokens)
  - Implement SSH certificate authority for enterprise key management
  - Consider using Azure AD authentication for SSH (preview feature)

references:
  - https://learn.microsoft.com/en-us/azure/virtual-machines/linux/mac-create-ssh-keys
  - https://learn.microsoft.com/en-us/azure/virtual-machines/linux/ssh-from-windows
  - https://learn.microsoft.com/en-us/azure/virtual-machines/linux/security-recommendations
  - https://learn.microsoft.com/en-us/azure/templates/microsoft.compute/virtualmachines
  - https://github.com/projectdiscovery/nuclei-templates/blob/main/cloud/azure/virtualmachines/azure-vm-ssh-auth-type.yaml
query: |
  resources
  | where type =~ 'microsoft.compute/virtualmachines'
  | where properties.storageProfile.osDisk.osType =~ 'Linux'
  | extend disablePasswordAuth = tobool(properties.osProfile.linuxConfiguration.disablePasswordAuthentication)
  | where disablePasswordAuth == false or isnull(disablePasswordAuth)
  | project
      id,
      name,
      type,
      location,
      resourceGroup,
      subscriptionId,
      disablePasswordAuth
