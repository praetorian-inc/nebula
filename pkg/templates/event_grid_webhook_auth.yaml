id: event_grid_subscription_webhook_auth
name: Event Grid Subscription Webhook Without Azure AD Authentication
description: Detects Event Grid subscriptions with webhook destinations that lack Azure Active Directory authentication, allowing anyone who discovers the webhook URL to send spoofed events.
severity: High
category: ["Public Access", "arg-scan"]
reportability: Manual Triage
triageNotes: |
  Security Risk:
  Event Grid subscriptions with webhook destinations that lack Azure AD authentication allow anyone who discovers
  the webhook URL to send spoofed events. This can lead to:

  - Unauthorized event injection into business workflows
  - Data manipulation through fake events
  - Business logic bypass (e.g., fake payment confirmations, fake user registrations)
  - Denial of service through event flooding
  - Compliance violations (lack of sender authentication)

  Understanding Webhook Authentication:
  - Azure AD authentication (azureActiveDirectoryTenantId): Azure validates the Event Grid service identity using OAuth 2.0
  - Alternative methods: Shared secrets in URL query parameters, custom header validation, IP allowlisting
  - No authentication: Webhook accepts any POST request with valid event schema

  Triage Guidance:
  1. **Check for Azure AD auth**: If azureActiveDirectoryTenantId exists → webhook is SECURE (Azure handles auth)
  2. **Enricher testing**: Review enricher HTTP test results:
     - 401/403 response → webhook requires authentication (SECURE)
     - 400 Bad Request → webhook validates event schema (MANUAL REVIEW - may have alternative auth)
     - 200 OK → webhook accepted test event (VULNERABLE - no auth enforcement)
     - Connection timeout/refused → webhook behind firewall or private endpoint (SECURE)
  3. **Check for shared secret**: Examine webhook URL for query parameters like `?code=xxx` or `?token=xxx`
  4. **Verify custom header validation**: Check if webhook server implements custom header authentication
  5. **Test webhook security**: Use enricher commands to test actual accessibility
  6. **Network isolation**: Verify if webhook is behind private endpoint or firewall rules

  Remediation Steps:
  1. **Recommended**: Enable Azure AD authentication:
     - Create Azure AD app registration
     - Configure azureActiveDirectoryTenantId and azureActiveDirectoryApplicationIdOrUri
     - Webhook validates Bearer token from Event Grid service
  2. **Alternative**: If Azure AD not feasible:
     - Add shared secret to webhook URL query parameters (less secure - secret in URL)
     - Implement custom header validation in webhook server
     - Use IP allowlisting (Event Grid service IP ranges)
     - Deploy webhook behind private endpoint (network isolation)
  3. **Defense in depth**: Combine multiple controls (Azure AD + TLS 1.2 + private endpoint)

  False Positive Scenarios:
  - Webhooks behind private endpoints with network isolation
  - Webhooks with IP-based firewall rules
  - Webhooks that implement custom header validation (not visible in Azure properties)
  - Webhooks using shared secrets in URL (visible in enricher output)

  Manual Verification Commands:
  ```bash
  # Show full subscription details including webhook URL
  az eventgrid system-topic event-subscription show \
    --name <subscription-name> \
    --system-topic-name <system-topic-name> \
    --resource-group <resource-group>

  # Check webhook URL for shared secrets
  # Look for query parameters like ?code=xxx or ?token=xxx

  # Test webhook authentication (use enricher results)
  curl -X POST -H "Content-Type: application/json" \
    -H "aeg-event-type: Notification" \
    -d '[{"id":"test","eventType":"test","subject":"test","data":{}}]' \
    <webhook-url>
  ```

  Additional Context:
  - High severity due to potential for unauthorized event injection
  - Enricher performs dynamic testing to reduce false positives
  - Manual triage required for webhooks with alternative authentication methods

references:
  - https://learn.microsoft.com/en-us/azure/event-grid/security-authentication
  - https://learn.microsoft.com/en-us/azure/event-grid/secure-webhook-delivery
  - https://learn.microsoft.com/en-us/azure/templates/microsoft.eventgrid/systemtopics/eventsubscriptions
  - https://learn.microsoft.com/en-us/azure/event-grid/security-authorization

query: |
  resources
  | where type =~ 'Microsoft.EventGrid/systemTopics/eventSubscriptions'
      or type =~ 'Microsoft.EventGrid/topics/eventSubscriptions'
      or type =~ 'Microsoft.EventGrid/domains/eventSubscriptions'
  | extend destination = properties.destination
  | extend destinationType = tostring(destination.endpointType)
  | extend destinationProps = destination.properties
  | where destinationType =~ 'WebHook'
  | extend azureAdTenantId = tostring(destinationProps.azureActiveDirectoryTenantId)
  | extend azureAdAppId = tostring(destinationProps.azureActiveDirectoryApplicationIdOrUri)
  | extend endpointUrl = tostring(destinationProps.endpointUrl)
  | extend minimumTlsVersion = tostring(destinationProps.minimumTlsVersionAllowed)
  | where isempty(azureAdTenantId) or isnull(azureAdTenantId)
  | project
      id,
      name,
      type,
      location,
      resourceGroup,
      subscriptionId,
      destinationType,
      azureAdTenantId,
      azureAdAppId,
      endpointUrl,
      minimumTlsVersion
